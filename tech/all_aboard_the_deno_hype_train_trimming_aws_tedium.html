<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js coal">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>All Aboard the Deno Hype Train: Trimming AWS Tedium - Terkwood Farms</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "coal";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../preface.html">Preface</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/index.html"><strong aria-hidden="true">1.</strong> BUGOUT: Play Go against AI 💪 and Human Friends 👪</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/BUGOUT/emo.html"><strong aria-hidden="true">1.1.</strong> Emotional Backdrop</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/building_the_project.html"><strong aria-hidden="true">1.2.</strong> Building the Project</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/too_cheap.html"><strong aria-hidden="true">1.3.</strong> Too Cheap for Pro Tier</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/welcome_katago.html"><strong aria-hidden="true">1.4.</strong> Welcome KataGo</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/a_happy_ending.html"><strong aria-hidden="true">1.5.</strong> A Happy Ending</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/further_inspiration.html"><strong aria-hidden="true">1.6.</strong> Further Inspiration</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/lab_notes.html"><strong aria-hidden="true">1.7.</strong> Some Lab Notes</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/fedora_coreos.html"><strong aria-hidden="true">1.8.</strong> Fedora CoreOS</a></li><li class="chapter-item expanded "><a href="../tech/BUGOUT/more_lab_notes.html"><strong aria-hidden="true">1.9.</strong> More Lab Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/adding_redis_streams_to_rust.html"><strong aria-hidden="true">2.</strong> Adding Redis Streams to Rust</a></li><li class="chapter-item expanded "><a href="../tech/the_midi_light_show.html"><strong aria-hidden="true">3.</strong> The MIDI Light Show</a></li><li class="chapter-item expanded "><a href="../tech/prawnalith/index.html"><strong aria-hidden="true">4.</strong> The Prawnalith: Electronics, Tanks, and Glory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/prawnalith/lab_notes.html"><strong aria-hidden="true">4.1.</strong> Lab Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/object_detection.html"><strong aria-hidden="true">5.</strong> Vision Project, Object Detection Resources</a></li><li class="chapter-item expanded "><a href="../tech/penguin_hell.html"><strong aria-hidden="true">6.</strong> Penguin Hell</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/convert_mp4_to_gif_using_ffmpeg.html"><strong aria-hidden="true">6.1.</strong> Convert MP4 to GIF using ffmpeg</a></li><li class="chapter-item expanded "><a href="../tech/ctop_selinux_docker.html"><strong aria-hidden="true">6.2.</strong> Running ctop docker container in privileged mode under SELinux</a></li><li class="chapter-item expanded "><a href="../tech/focus_alacritty_gnome.html"><strong aria-hidden="true">6.3.</strong> Use Keyboard Shortcut to Focus Alacritty in GNOME</a></li><li class="chapter-item expanded "><a href="../tech/tmux_alacritty_scroll.html"><strong aria-hidden="true">6.4.</strong> Easy scrolling with tmux and alacritty</a></li><li class="chapter-item expanded "><a href="../tech/systemd.html"><strong aria-hidden="true">6.5.</strong> Systemd and Systemctl</a></li><li class="chapter-item expanded "><a href="../tech/linux_clipboard_from_command_line.html"><strong aria-hidden="true">6.6.</strong> Using the clipboard in a linux shell</a></li><li class="chapter-item expanded "><a href="../tech/vim.html"><strong aria-hidden="true">6.7.</strong> Vim</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/distributed_wasteland.html"><strong aria-hidden="true">7.</strong> Distributed Wasteland</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/trying_out_yugabyte.html"><strong aria-hidden="true">7.1.</strong> Trying out Yugabyte</a></li><li class="chapter-item expanded "><a href="../tech/hello_tikv.html"><strong aria-hidden="true">7.2.</strong> Hello TiKV</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/cloud_crap.html"><strong aria-hidden="true">8.</strong> Cloud Crap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/aws_cli.html"><strong aria-hidden="true">8.1.</strong> AWS CLI</a></li><li class="chapter-item expanded "><a href="../tech/trying_google_cloud_run.html"><strong aria-hidden="true">8.2.</strong> Trying Google Cloud Run</a></li><li class="chapter-item expanded "><a href="../tech/using_git_annex_with_google_cloud_storage.html"><strong aria-hidden="true">8.3.</strong> Using Git Annex with Google Cloud Storage</a></li><li class="chapter-item expanded "><a href="../tech/gcp_show_size_of_bucket_gsutil.html"><strong aria-hidden="true">8.4.</strong> GCP: Show size of bucket using gsutil</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/denoland.html"><strong aria-hidden="true">9.</strong> DenoLand</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/all_aboard_the_deno_hype_train_trimming_aws_tedium.html" class="active"><strong aria-hidden="true">9.1.</strong> All Aboard the Deno Hype Train: Trimming AWS Tedium</a></li><li class="chapter-item expanded "><a href="../tech/deno_file_server_upgrade.html"><strong aria-hidden="true">9.2.</strong> deno file_server upgrade</a></li><li class="chapter-item expanded "><a href="../tech/using_deno_in_vscode.html"><strong aria-hidden="true">9.3.</strong> Using Deno in VsCode</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/junk_drawer.html"><strong aria-hidden="true">10.</strong> Else</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tech/h264_live_camera.html"><strong aria-hidden="true">10.1.</strong> H264 Live Camera Fork</a></li><li class="chapter-item expanded "><a href="../tech/racket.html"><strong aria-hidden="true">10.2.</strong> Racket</a></li><li class="chapter-item expanded "><a href="../tech/lolbots.html"><strong aria-hidden="true">10.3.</strong> lolbots</a></li><li class="chapter-item expanded "><a href="../tech/deepdream.html"><strong aria-hidden="true">10.4.</strong> Deepdream</a></li><li class="chapter-item expanded "><a href="../tech/setting_up_mdbook.html"><strong aria-hidden="true">10.5.</strong> Setting up mdBook</a></li><li class="chapter-item expanded "><a href="../tech/github_pages.html"><strong aria-hidden="true">10.6.</strong> Setting up Github Pages</a></li><li class="chapter-item expanded "><a href="../tech/ffmpeg.html"><strong aria-hidden="true">10.7.</strong> ffmpeg</a></li><li class="chapter-item expanded "><a href="../tech/wtf_why_is_firefox_so_slow_on_linux.html"><strong aria-hidden="true">10.8.</strong> WTF WHY IS FIREFOX SO SLOW ON LINUX</a></li></ol></li><li class="chapter-item expanded "><a href="../tech/oss_commitment_tracking.html"><strong aria-hidden="true">11.</strong> OSS Commitment Tracking</a></li><li class="chapter-item expanded "><a href="../fun/index.html"><strong aria-hidden="true">12.</strong> Fun Stuff</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fun/music_directory.html"><strong aria-hidden="true">12.1.</strong> Music Directory</a></li><li class="chapter-item expanded "><a href="../fun/fallout_shelter_9999_lunch_boxes.html"><strong aria-hidden="true">12.2.</strong> Fallout Shelter: 9999 Lunch Boxes Cheat</a></li></ol></li><li class="chapter-item expanded "><a href="../source.html">Source Code</a></li><li class="chapter-item expanded affix "><a href="../feedback.html">Providing Feedback</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Terkwood Farms</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="https://user-images.githubusercontent.com/38859656/82162993-328ebe80-9876-11ea-930f-5f5d881f75a1.jpg" alt="ALL ABOARD" /></p>
<h1 id="all-aboard-the-deno-hype-train-trimming-aws-tedium"><a class="header" href="#all-aboard-the-deno-hype-train-trimming-aws-tedium">All Aboard the Deno Hype Train: Trimming AWS Tedium</a></h1>
<p>This article explores the use of <a href="https://deno.land/">Deno</a> to automate repetitive AWS clean-up tasks.  We conclude by installing a <code>cron</code> job that wakes up our laptop and disposes of our AWS testing resources every night.</p>
<p>Please be advised that this article is for educational purposes only.</p>
<p>If you blindly follow all the instructions, you'll end up deleting all your AMIs and snapshots.  ⚠️</p>
<h2 id="detail"><a class="header" href="#detail">Detail</a></h2>
<p>As part of our daily development cycle, we create a couple
of virtual machine images in AWS, then forget about them
for a while.  At some point, we boot them up and use them,
and then throw them away.</p>
<p>Once the instances are running, we have no more need for
the AMIs from which they were created, and, crucially,
we don't want to continue spending on the snapshot volumes
to which the AMIs are registered. </p>
<p>💸 Snapshots cost money! 💸</p>
<p>So, for the last few days we've followed a manual workflow to clean up our newly created machine images and snapshots, and that's a big waste of time.</p>
<p>Instead of using the AWS command-line interface to manage the clean-up of these snapshots and machine images, we decided to write a small script using Deno!  After all, the documentation claims that it's a good fit for use cases where you would otherwise employ a small bash or python script.</p>
<p>Follow along and decide for yourself whether it's an improvement.</p>
<h2 id="tedious-motivating-example"><a class="header" href="#tedious-motivating-example">Tedious, Motivating Example</a></h2>
<p>So, this is the painfully slow workflow that we used to clean things up by hand.  Sure, it only takes a minute, or maybe two (if we're feeling slow).  But keep in mind that we've been doing this every day for the last week... 🤢</p>
<p>First, we find the images we control:</p>
<pre><code class="language-sh">aws ec2 describe-images --owners self|grep ami
</code></pre>
<p>▶️ ▶️ ▶️</p>
<pre><code class="language-text">&quot;ImageId&quot;: &quot;ami-0aaaaaaaaaaaaaaaa&quot;,
&quot;ImageId&quot;: &quot;ami-0bbbbbbbbbbbbbbbb&quot;,
</code></pre>
<p>Deregister (disassociate) their respective volumes:</p>
<pre><code class="language-sh">aws ec2 deregister-image --image-id ami-0aaaaaaaaaaaaaaaa
aws ec2 deregister-image --image-id ami-0bbbbbbbbbbbbbbbb
</code></pre>
<p>Now that the images are deregistered, find all of our snapshots:</p>
<pre><code class="language-sh">aws ec2 describe-snapshots --owner self | grep snap-
</code></pre>
<p>▶️ ▶️ ▶️</p>
<pre><code class="language-text">&quot;SnapshotId&quot;: &quot;snap-0cccccccccccccccc&quot;,
&quot;SnapshotId&quot;: &quot;snap-0dddddddddddddddd&quot;,
</code></pre>
<p>Finally, destroy these snapshots </p>
<pre><code class="language-sh">aws ec2 delete-snapshot --snapshot-id snap-0cccccccccccccccc
aws ec2 delete-snapshot --snapshot-id snap-0dddddddddddddddd
</code></pre>
<p>What colossal a waste of time!</p>
<h2 id="pleasantly-hyped-automation"><a class="header" href="#pleasantly-hyped-automation">Pleasantly Hyped Automation</a></h2>
<p>OK, here's the fun part.  Let's rewrite this junk using the shiniest,  newest tech! 🦕 </p>
<p>Our workflow requires that we look up both Amazon Machine Image (AMI) IDs, as well as Snapshot IDs.  We deregister the AMIs one by one, and we delete the snapshots one by one, as well.</p>
<p>Executing a command via subprocess is easily accomplished using <code>Deno.run</code>.  Here we use <code>stdout: &quot;piped&quot;</code> because we'll want to capture the output from the command and manipulate it:</p>
<pre><code class="language-typescript">const p = Deno.run({ cmd: [&quot;/usr/bin/aws&quot;, &quot;ec2&quot;, &quot;describe-images&quot;, &quot;--owners&quot;, &quot;self&quot;], stdout: &quot;piped&quot; });

const { code } = await p.status();

if (code !== 0) {
    const rawError = await p.stderrOutput();
    const errorString = new TextDecoder().decode(rawError);
    console.log(errorString);
    Deno.exit(code);
}
</code></pre>
<p>If we were to run this command directly in a terminal, we'd see
something like this:</p>
<pre><code class="language-json">{
    &quot;Images&quot;: [
        {
            &quot;Architecture&quot;: &quot;x86_64&quot;,
            &quot;CreationDate&quot;: &quot;1970-01-01T08:25:24.000Z&quot;,
            &quot;ImageId&quot;: &quot;ami-0aaaaaaaaaaaaaaaa&quot;,
            // ... SNIP ...
        },
        {
            &quot;Architecture&quot;: &quot;x86_64&quot;,
            &quot;CreationDate&quot;: &quot;1970-01-01T08:15:13.000Z&quot;,
            &quot;ImageId&quot;: &quot;ami-0bbbbbbbbbbbbbbbb&quot;,
            /// ... SNIP ...
        }
    ]
}
</code></pre>
<p>Using <code>grep</code> to pull out the <code>ImageId</code> field will leave us with an ugly line of text which we then need to further trim down to the actual ID. And we're too lazy to write a proper regex. 🌝</p>
<p>Thankfully, Typescript makes this dead simple for us, since it handles JSON very naturally:</p>
<pre><code class="language-typescript">const { Images } = JSON.parse(new TextDecoder().decode(await p.output()));

for (let { ImageId } of Images) {
  await Deno.run({ 
        cmd: [&quot;aws&quot;, &quot;ec2&quot;, &quot;deregister-image&quot;, &quot;--image-id&quot;, ImageId] 
    });
}
</code></pre>
<p>Fast-forwarding a bit, we can streamline our code by pulling out the <code>JSON.parse</code> call used with every AWS CLI invocation, and declaring it as a function:</p>
<pre><code class="language-typescript">const parseProcessOutput = async (p: Deno.Process) =&gt;
  JSON.parse(new TextDecoder().decode(await p.output()));
</code></pre>
<p>We also wanted to stop &quot;typing&quot;, &quot;all&quot;, &quot;our&quot;, &quot;arguments&quot;, &quot;to&quot;, &quot;the&quot;, &quot;Deno.run&quot;, &quot;cmd&quot; as comma-separated strings, because we're lazy 👼:</p>
<pre><code class="language-typescript">const awsEc2Cmd = (argStr: string) =&gt; {
  let o = [];
  o.push(&quot;/usr/bin/aws&quot;);
  o.push(&quot;ec2&quot;);
  for (let s of argStr.split(&quot; &quot;)) {
    o.push(s);
  }

  return o;
};
</code></pre>
<p>With these little helpers declared, cleaning up our expen$ive image snapshots is now easy:</p>
<pre><code class="language-typescript">const dsp = await runOrExit(
  {
    cmd: awsEc2Cmd(&quot;describe-snapshots --owner self&quot;),
    stdout: &quot;piped&quot;,
  },
);

const { Snapshots } = await parseProcessOutput(dsp);

for (let { SnapshotId } of Snapshots) {
  await runOrExit(
    {
      cmd: awsEc2Cmd(`delete-snapshot --snapshot-id ${SnapshotId}`),
      stdout: undefined,
    },
  );
}
</code></pre>
<p>That's fully HALF of our daily dev trash that we generate.  We also tend to run a couple of instances in our AWS dev environment.  We want to terminate both of those instances.  One of the two will usually have an elastic IP associated with it, so we make sure to release that IP and avoid charges.</p>
<p>Here's the complete script, which depends on our above helpers being defined in a <code>procs.ts</code> file: </p>
<pre><code class="language-typescript">import { runOrExit, parseProcessOutput, awsEc2Cmd } from &quot;./procs.ts&quot;;
import { config as loadEnv } from &quot;https://deno.land/x/dotenv@v0.3.0/mod.ts&quot;;

console.log(loadEnv({ safe: true, export: true }));

// This is the instance tag &quot;Name&quot;, used to identify
// our dev environment instances.
// It's loaded from a .env file which looks like this:
//
// KEY_NAME=my-fancy-dev-instance-tag
const KEY_NAME = Deno.env.get(&quot;KEY_NAME&quot;);

let instsDescd = runOrExit(
  { cmd: awsEc2Cmd(&quot;describe-instances&quot;), stdout: &quot;piped&quot; },
);

let addrsDescd = runOrExit(
  { cmd: awsEc2Cmd(&quot;describe-addresses&quot;), stdout: &quot;piped&quot; },
);

const { Reservations } = await parseProcessOutput(await instsDescd);

let instancesToTerminate = [];
for (let { Instances } of Reservations) {
  for (let { InstanceId, KeyName } of Instances) {
    if (KEY_NAME === KeyName) {
      instancesToTerminate.push(InstanceId);
    }
  }
}

const { Addresses } = await parseProcessOutput(await addrsDescd);

let addressesToRelease = [];
for (let { InstanceId, AllocationId, AssociationId } of Addresses) {
  if (instancesToTerminate.includes(InstanceId)) {
    addressesToRelease.push({ AllocationId, AssociationId });
  }
}

if (addressesToRelease.length &gt; 0) {
  console.log(`Addresses to release  : ${JSON.stringify(addressesToRelease)}`);

  for (let { AssociationId, AllocationId } of addressesToRelease) {
    await runOrExit({
      cmd: awsEc2Cmd(`disassociate-address --association-id ${AssociationId}`),
    });

    await runOrExit({
      cmd: awsEc2Cmd(`release-address --allocation-id ${AllocationId}`),
    });
  }
}

if (instancesToTerminate.length &gt; 0) {
  console.log(
    `Instances to terminate: ${JSON.stringify(instancesToTerminate)}`
  );

  await runOrExit({
    cmd: awsEc2Cmd(
      `terminate-instances --instance-ids ${instancesToTerminate.join(&quot; &quot;)}`
    ),
  });
}

Deno.exit(0);
</code></pre>
<p>When I run this script, my credit card sighs in glorious relief. 🤓</p>
<h2 id="the-triggered-clean-up-nirvana"><a class="header" href="#the-triggered-clean-up-nirvana">The Triggered Clean-Up Nirvana</a></h2>
<p>Yes, we prefer to watch Stargate SG-1 and Fringe at 9pm.  We do not remember to clean up our precious AWS resources.</p>
<p>We need a <em>cron job</em>!</p>
<p>It should wake up this x86_64 laptop from sleep, and use our local AWS credentials to trigger the cleanup scripts.</p>
<p>Why not just run this on a local raspberry pi, or something?  We have at least one of those running 24/7, so we wouldn't need to mess with forcing a wakeup from sleep.</p>
<p>Well, it turns out that Deno <strong>can't run on ARM platforms yet</strong>.  Oh well!</p>
<p>As long as we can wake up our power-hungry laptop reliably, we don't mind a little bit of a hacky solution, here.  It beats waking up our <em>human body</em> to take care of such a tedious task!</p>
<h3 id="try-out-rtcwake"><a class="header" href="#try-out-rtcwake">Try Out RtcWake</a></h3>
<p>We'll attempt to <a href="https://www.addictivetips.com/ubuntu-linux-tips/automatically-wake-linux-up-from-sleep/">use RtcWake to jolt our laptop into consciousness</a>.</p>
<p>🎵 🔈 First, put the music on nice and loud... 🎹 👾</p>
<pre><code class="language-sh"># install debian &amp; ubuntu
sudo apt install -y util-linux

# put the laptop to sleep for 10 seconds, then resume
sudo rtcwake -u -s 10 -m mem
</code></pre>
<p>Blackout... 🙈</p>
<p>...and in 10 seconds, we heard our tunes pop right back into place! 👂 🏁</p>
<h3 id="scheduled-wake-up"><a class="header" href="#scheduled-wake-up">Scheduled Wake-Up</a></h3>
<p>We're gonna need to do this by cron, so we need to be able to</p>
<pre><code class="language-sh">sudo rtcwake -m no -l -t $(date +%s -d 'today 19:15')
</code></pre>
<p>⌚️ Try this at 19:14, then wait...</p>
<p>🌞 No problems!</p>
<h3 id="add-some-crontab-love-"><a class="header" href="#add-some-crontab-love-">Add some crontab love 💟</a></h3>
<p>Well, we left a disk sitting around in AWS for a couple of weeks and it cost us a bit of money.  We dithered and didn't bother to release our article.  NOW WE HAVE GREAT RESOLVE!</p>
<p>We shall run a crontab.</p>
<p>We shall always clean up our expensive dev trash!</p>
<p><a href="https://serverfault.com/a/352837">We shall google for how to do this and then tell you about it</a>.</p>
<p>Entering the local user and editing the crontab file for correctness before committing it</p>
<pre><code class="language-sh">sudo crontab -u FRIENDLY_USER -e
</code></pre>
<p>This was our test run.  We tried a deno script which invoked <code>wall</code>, to make sure we could run our more complex deno logic for the dev environment &amp; AMI/snapshot cleanups.</p>
<p><img src="https://user-images.githubusercontent.com/38859656/84583409-360a5c80-adc6-11ea-8983-5e4925771d85.png" alt="test drive" /></p>
<h3 id="final-plan-"><a class="header" href="#final-plan-">Final Plan 📆</a></h3>
<ul>
<li>crontab: (as root!) periodically schedule RTC wake at 23:27 </li>
<li>crontab (as user, three minutes later): destroy all snapshots and AMIs using deno script</li>
<li>crontab (as user, also three minutes later): destroy any dev environment instances</li>
</ul>
<p>That's it.  Our laptop is configured to go back to sleep relatively quickly, so we shouldn't burn too much disgusting coal power (don't hate, we live in Indiana 🤢 🏭) after it kicks on.</p>
<h4 id="the-rtc-wake-up-spammer-used-by-root-crontab"><a class="header" href="#the-rtc-wake-up-spammer-used-by-root-crontab">The RTC Wake-Up Spammer used by ROOT Crontab</a></h4>
<p><img src="https://user-images.githubusercontent.com/38859656/84583855-ba131300-adcb-11ea-9525-439d1a4ad5a1.png" alt="rtc spammer as root" /></p>
<h4 id="the-cleanup-crontab-for-normal-user"><a class="header" href="#the-cleanup-crontab-for-normal-user">The cleanup crontab for Normal User</a></h4>
<p><img src="https://user-images.githubusercontent.com/38859656/84583924-ca77bd80-adcc-11ea-91c9-a4f98cbca6ff.png" alt="normal user cleanup" /></p>
<p>We need to make sure the <code>KEY_NAME</code> var is exposed in the environment.  First attempt above, failed.</p>
<p>Add another pic...</p>
<h4 id="checking-for-correctness"><a class="header" href="#checking-for-correctness">Checking for Correctness</a></h4>
<p>We should make sure that the instances are destroyed, their disks destroyed, elastic IP released completely, snapshots destroyed, AMIs destroyed.</p>
<p>Although our overall approach is a hack, we're willing to accept the disorganization... <em>as long as everything actually works</em>!</p>
<h2 id="references-and-attributions"><a class="header" href="#references-and-attributions">References and Attributions</a></h2>
<p><a href="https://ccsearch.creativecommons.org/photos/b66ad5eb-8395-4eaa-a26f-ba680b23f027">train image</a> by fsse8info is licensed under CC BY-SA 2.0.</p>
<p>The initial nugget of subprocess management originates in the <a href="https://deno.land/manual/examples/subprocess">Deno manual subprocess example</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../tech/denoland.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../tech/deno_file_server_upgrade.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../tech/denoland.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../tech/deno_file_server_upgrade.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
